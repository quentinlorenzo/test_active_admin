<%# 
  Composant réutilisable pour les graphiques en camembert.
  Paramètres requis :
  - canvas_id: ID du canvas HTML
  - labels: Tableau des étiquettes
  - data: Tableau des valeurs
  - background_colors: Tableau des couleurs
  - title: Titre du graphique
  - metric_name: Nom de la métrique (ex: "impressions", "clics") 
%>
<div class="graph-wrapper">
  <canvas id="<%= canvas_id %>"></canvas>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('<%= canvas_id %>').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: <%= raw labels.to_json %>,
        datasets: [{
          data: <%= raw data.to_json %>,
          backgroundColor: [
            '#FF6384',  //Rose
            '#36A2EB',  //Bleu
            '#FFCE56',  //Jaune
            '#4BC0C0',  //Turquoise
            '#9966FF',  //Violet
            '#FF9F40',  //Orange
            '#8AC24A',  //Vert clair
            '#FF5722',  //Rouge-orange
            '#607D8B',  //Bleu-gris
            '#9C27B0',  //Violet foncé
            '#00BCD4',  //Cyan
            '#795548',  //Marron
            '#CDDC39',  //Lime
            '#3F51B5',  //Indigo
            '#E91E63'   //Rose foncé
            ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: '<%= title %>'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.raw;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${context.label}: ${percentage}% (${value.toLocaleString()} <%= metric_name %>)`;
              }
            }
          },
          datalabels: {
            formatter: (value, ctx) => {
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              const label = ctx.chart.data.labels[ctx.dataIndex];
              return `${percentage}%\n${label}`;
            },
            color: '#fff',
            font: {
              weight: 'bold',
              size: 14
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  });
</script> 